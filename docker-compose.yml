version: '2.4'

services:
  kbd:
    depends_on:
      # If you are using a separate instance of lnd, this is unnecessary
      - lnd_btc
    build:
      context: ./
      dockerfile: docker/kbd/Dockerfile
    volumes:
      - './bin:/home/app/bin'
      - './broker-daemon:/home/app/broker-daemon/'
      - '/data'
      # This is populated externally w/ an engine
      - 'shared:/shared'
    environment:
      # - GRPC_VERBOSITY=INFO
      # - GRPC_TRACE=all
      - NODE_PATH=.
      - RPC_ADDRESS=0.0.0.0:27492
      - INTERCHAIN_ROUTER_ADDRESS=0.0.0.0:40369
      - DATA_DIR=/data
      - LND_HOST=lnd_btc:10009
      - LND_TLS_CERT=/shared/lnd-engine-tls.cert
      - LND_MACAROON=/shared/lnd-engine-admin.macaroon
      - GRPC_SSL_CIPHER_SUITES=HIGH+ECDSA
      # This address is specifically tied to the relayer network
      - ENGINE_TYPE=lnd
      # This is a temporary workaround for preventing the use of external networks
      # for the relayer. In a testnet/mainnet setting, this will be a public IP.
      - EXCHANGE_RPC_HOST=docker.for.mac.host.internal:28492
      - EXCHANGE_LND_HOST=docker.for.mac.host.internal:10111
      - LND_EXTERNAL_ADDRESS=docker.for.mac.host.internal:10112
      - EXTERNAL_ADDRESS=docker.for.mac.host.internal:27492
      - MARKETS=BTC/LTC
    ports:
      - '27492:27492'
    expose:
      - '27492'
    networks:
      - broker
      - lnd
    working_dir: '/home/app'
    entrypoint: bash -c 'npm run start-kbd'

  lnd_btc:
    depends_on:
      - btcd
    extends:
      file: ./docker/lnd-docker-compose.yml
      service: lnd_btc
    build:
      context: ./docker
    ports:
      - '10112:10112'
    environment:
      - LISTEN=0.0.0.0:10112
      - EXTERNAL_ADDRESS=docker.for.mac.host.internal:10112
      # This is only needed for simnet w/ relayer due to having 1 simnet btcd
      # node for the entire network
      #
      # Here we are setting the host to a public IP and also using a different
      # public cert
      - RPC_HOST=docker.for.mac.host.internal
      - RPC_CERT_PATH=/shared/simnet-rpc.cert

  btcd:
    extends:
      file: ./docker/lnd-docker-compose.yml
      service: btcd
    build:
      context: ./docker


volumes:
  shared:
  # These volumes are used in lnd/btc
  lnd:
  bitcoin:

networks:
  broker:
  lnd:
