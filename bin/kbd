#!/usr/bin/env node

/**
 * Kinesis Broker Daemon
 */

const path = require('path');
const program = require('caporal');

const startServer = require('../broker-daemon');

const { version: CLI_VERSION } = require('../package.json');

const KINESIS_RPC_HOST = process.env.KINESIS_RPC_HOST || 'locahost:27492';
const KINESIS_PORTS = process.env.KINESIS_PORTS || null;
const KINESIS_EXTERNAL_HOST = process.env.KINESIS_EXTERNAL_HOST || null;
const KINESIS_DATA_DIR = process.env.KINESIS_DATA_DIR || '~/.kinesis/data';

const LND_RPC_HOST = process.env.LND_RPC_HOST || 'localhost:10009';
const LND_TLS_PATH = process.env.LND_TLS_PATH || '~/.lnd/tls.cert';
const LND_MACAROON_PATH = process.env.LND_MACAROON_PATH || '~/.lnd/admin.macaroon';

program
  .version(CLI_VERSION)
  // Kinesis Specific Commands
  .option('--rpc-address <server>', 'Host and port to set up the RPC server on.', /^.+(:[0-9]*)?$/, KINESIS_RPC_HOST)
  .option('--ports <portRange>', 'Range of UDP ports for kinesisd to accept peer connections on.', /^[0-9]+-[0-9]+$/, KINESIS_PORTS)
  .option('--external-host <hostname>', 'Hostname that peers can use to reach you.', /^.+$/, KINESIS_EXTERNAL_HOST)
  .option('--data-dir <path>', 'Location to store kinesisd data.', /^.+$/, KINESIS_DATA_DIR)
  // LND Specific commands
  .option('--lnd-rpc <server>', 'Location of the LND RPC server to use.', /^.+(:[0-9]*)?$/, LND_RPC_HOST)
  .option('--lnd-tls <path>', 'Location of the certificate to use when communicating with LND.', /^.+$/, LND_TLS_PATH)
  .option('--lnd-macaroon <path>', 'Location of the macaroon to use when communicating with LND.', /^.+$/, LND_MACAROON_PATH)
  .action(startServer);

program.parse(process.argv);
